---
import { getCollection } from "astro:content";
import ProjectCard from "../components/ProjectCard.astro";
import Layout from "../layouts/Layout.astro";
import { Image } from "astro:assets";
import SearchIcon from "../images/common/SearchIcon.svg";
import { tags } from "../scripts/tags";
import TagContainer from "../components/TagContainer.astro";

const projects = await getCollection("projects", ({data}) => {
    return !data.isUnlisted;
});

// Sort by rank, lower rank first
projects.sort((a, b) => {
    if (a.data.rank < b.data.rank)
        return -1;
    else if (a.data.rank == b.data.rank)
        return 0;
    else
        return 1;
})
---
<Layout title="Projects" description="A list of all the projects I've worked.">
    <h1>Projects</h1>
    <div class="container">
        <div class="filter-panel card">
            <div class="search-bar">
                <Image src={SearchIcon} alt="Search Icon" class:list="search-icon"/>
                <!-- TODO: Add keyword -->
                <input type="search" id="search-input" placeholder="Search by Title or tag"/>
            </div>
            <div class="radio-tab-selection">
                <input type="radio" id="tab-tag" value="tab-tag" name="tab-selection" checked> 
                <label for="tab-tag">Tag</label>
                <input type="radio" id="tab-options" value="tab-options" name="tab-selection"> 
                <label for="tab-options">Options</label>
            </div>
            <div class="filter-tag-tab">
            {
                tags.childTags.map(tag => 
                    <div class="filter-tag-container">
                        <span>{tag.tag}</span>
                        <TagContainer tags={tag.childTags}/>
                        {/* { tag.childTags.length !== 0 && 
                            <ul>
                                {
                                    tag.childTags.map(tagChild1 => 
                                        <li>{tagChild1.tag}</li>
                                    )
                                }
                            </ul>
                        } */}
                    </div>
                )
            }
            </div>
        </div>
        <div class="project-container">
            { projects.map((project) => <ProjectCard project={project}/>) }
            <div class="card" id="no-project-found">No projects found. If the project should be here or if you want me to work on a project with that specifications, please <a href="/about/">contact me</a></div>
            <aside>Note: Actual time spent on each project may vary as most projects are done during my free time.</aside>
        </div>
    </div>
</Layout>

<style>
    /* :global(html) {
        background: none;
        background-color: var(--color-background);
    } */

    h1 {
        text-align: center;
    }

    .container {
        max-width: fit-content;
        display: flex;
        gap: 1em;
        margin-bottom: 5em;
    }
    
    .filter-panel {
        display: flex;
        position: sticky;
        top: 1em;
        width: 15em;
        height: fit-content;
        flex-direction: column;
        gap: 1em;

        hr {
            border-color: grey;
        }
    }

    .search-bar {
        display: flex;
        position: relative;

        /* TODO: Shift this to input[type="search"]::after */
        .search-icon {
            display: block;
            position: absolute;
            height: 1em;
            top: 0.6em;
            left: 0.6em;
        }

        input {
            width: 100%;
        }
    }

    .filter-tag-tab {
        display: flex;
        flex-direction: column;
        gap: 1em;

        .filter-tag-container ul {
            margin-top: 0.2em;
        }

        .tag {
            user-select: none;
            cursor: pointer;
            filter: none;
            width: fit-content;

            transition-property: opacity, padding, color, background-color;
            transition-duration: 0.2s;

            &:not(.include-tag):not(.exclude-tag) {
                opacity: 0.7;
            }

            &.include-tag, &.exclude-tag {
                padding-left: 1em;
            }

            &.exclude-tag {
                background-color: var(--color-secondary);
                color: white;
            }

            &::before {
                content: "";
                opacity: 0;
                position: absolute;
                font-size: 1.2em;
                font-weight: 800;
                transform-origin: center;
                transition: opacity 0.2s;
            }

            &.include-tag::before {
                content: "+ ";
                opacity: 1;
                transform: translate(-0.75em, -0.2em);
            }

            &.exclude-tag::before {
                content: "- ";
                opacity: 1;
                transform: translate(-0.6em, -0.2em);
            }

            @keyframes fade-in {
                from { opacity: 0%; }
                to { opacity: 100%; }
            }
        }
    }

    .project-container {
        display: flex;
        flex-direction: column;
        /* gap: 1em; */

        --project-card-max-height: 15em;
        --anim-duration: 1.2s;
        --anim-curve:cubic-bezier(0.18, 0.89, 0.32, 1.28);
        --anim-curve:cubic-bezier(0.25, 1.15, 0.37, 1.36);
        --anim-curve:cubic-bezier(0, 0.59, 0.33, 1.25);
        /* Bounce */
        --anim-curve: linear(0 0%, 0 2.27%, 0.02 4.53%, 0.04 6.8%, 0.06 9.07%, 0.1 11.33%, 0.14 13.6%, 0.25 18.15%, 0.39 22.7%, 0.56 27.25%, 0.77 31.8%, 1 36.35%, 0.89 40.9%, 0.85 43.18%, 0.81 45.45%, 0.79 47.72%, 0.77 50%, 0.75 52.27%, 0.75 54.55%, 0.75 56.82%, 0.77 59.1%, 0.79 61.38%, 0.81 63.65%, 0.85 65.93%, 0.89 68.2%, 1 72.7%, 0.97 74.98%, 0.95 77.25%, 0.94 79.53%, 0.94 81.8%, 0.94 84.08%, 0.95 86.35%, 0.97 88.63%, 1 90.9%, 0.99 93.18%, 0.98 95.45%, 0.99 97.73%, 1 100%);
        /* Elastic */
        --anim-curve: linear(0 0%, 0.22 2.1%, 0.86 6.5%, 1.11 8.6%, 1.3 10.7%, 1.35 11.8%, 1.37 12.9%, 1.37 13.7%, 1.36 14.5%, 1.32 16.2%, 1.03 21.8%, 0.94 24%, 0.89 25.9%, 0.88 26.85%, 0.87 27.8%, 0.87 29.25%, 0.88 30.7%, 0.91 32.4%, 0.98 36.4%, 1.01 38.3%, 1.04 40.5%, 1.05 42.7%, 1.05 44.1%, 1.04 45.7%, 1 53.3%, 0.99 55.4%, 0.98 57.5%, 0.99 60.7%, 1 68.1%, 1.01 72.2%, 1 86.7%, 1 100%);
        /* Emphasized */
        --anim-curve:linear(0 0%, 0 1.8%, 0.01 3.6%, 0.03 6.35%, 0.07 9.1%, 0.13 11.4%, 0.19 13.4%, 0.27 15%, 0.34 16.1%, 0.54 18.35%, 0.66 20.6%, 0.72 22.4%, 0.77 24.6%, 0.81 27.3%, 0.85 30.4%, 0.88 35.1%, 0.92 40.6%, 0.94 47.2%, 0.96 55%, 0.98 64%, 0.99 74.4%, 1 86.4%, 1 100%) ;
        --anim-curve:cubic-bezier(0, 0.59, 0.33, 1.25);
        --anim-curve:cubic-bezier(0.12,-0.54, 0.54, 1.03);
        --anim-curve:cubic-bezier(0.44,-0.66, 0.51, 1.24);
        --anim-curve:cubic-bezier(0.44,-0.66, 0.62, 1.71);
        --anim-curve:cubic-bezier(0.52,-1.16, 0.62, 1.71);
        --anim-curve:cubic-bezier(0.52,-1.16, 0.29, 2.45);
        --anim-curve:cubic-bezier(0.52,-1.16, 0.56, 3.32);
        --anim-curve:cubic-bezier(0.52,-1.16, 0.56, 2);
        --anim-curve:cubic-bezier(0.4,-1.2, 0.3, 2.1);

        /* --anim-curve:cubic-bezier(0.52,-1.16, 0.7, 2); */
        /* --anim-curve:cubic-bezier(0.52,-1.16, 0.5, 2.57); */

        .project-card {
            margin-bottom: 1em;
            /* transition-property: height, padding, margin-bottom, opacity; */
            /* transition-duration: 0.75s; */
            /* transition: opacity 0.5s, max-height 0.75s, padding 0.75s, margin-bottom 0.75s; */
            max-height: var(--project-card-max-height);
            overflow: hidden;
            padding: 1em;
            margin-bottom: 1em;
        }

        :not(.hide) {
            animation: 1s linear showCard both;
            animation: 0.75s cubic-bezier(0.42, 0.07, 0.55, 2) showCard both;
        }

        .hide {
            /* animation: 1.2s cubic-bezier(0.4,-1.2, 0.3, 2.1) hideCard both; */
            animation: 1s cubic-bezier(0.25,-1.2, 0.4, 2) hideCard both;

            /* max-height: 0; */
            /* padding: 0;
            margin-bottom: 0;
            opacity: 0; */
            /* display: none; */
        }

        /* Delay based on child */
        /* .just-changed {
            --animiation-delay-amt: 0.05s;
            &:nth-child(1) { animation-delay: calc(var(--animiation-delay-amt) * 1); }
            &:nth-child(2) { animation-delay: calc(var(--animiation-delay-amt) * 2); }
            &:nth-child(3) { animation-delay: calc(var(--animiation-delay-amt) * 3); }
            &:nth-child(4) { animation-delay: calc(var(--animiation-delay-amt) * 4); }
            &:nth-child(5) { animation-delay: calc(var(--animiation-delay-amt) * 5); }
            &:nth-child(6) { animation-delay: calc(var(--animiation-delay-amt) * 6); }
            &:nth-child(7) { animation-delay: calc(var(--animiation-delay-amt) * 7); }
            &:nth-child(8) { animation-delay: calc(var(--animiation-delay-amt) * 8); }
            &:nth-child(9) { animation-delay: calc(var(--animiation-delay-amt) * 9); }
            &:nth-child(10) { animation-delay: calc(var(--animiation-delay-amt) * 10); }
        } */
    }

    @keyframes hideCard {
        from {
            max-height: var(--project-card-max-height); 
            opacity: 1;
            padding: 1em;
            /* padding: 0; */
            /* transform: none; */
        }

        to {
            max-height: 0;
            padding: 0 1em;
            margin-bottom: 0;
            opacity: 0;
            /* transform: translateX(20em); */
        }
    }

    @keyframes showCard {
        from {
            max-height: 0;
            padding: 0 1em;
            margin-bottom: 0;
            opacity: 0;
        }

        to {
            max-height: var(--project-card-max-height); 
            /* padding: 1em;
            margin-bottom: 1em; */
            opacity: 1;
        }
    }

    @media (max-width: 70em) {
        .container {
            flex-direction: column;
        }

        .filter-panel {
            position: static;
            width: calc(100% - 2em);
        }

        .filter-tag-tab {
            flex-direction: row;
            flex-wrap: wrap;

            .filter-tag-container {
                /* TODO: Test this, wrap with background color? */
                /* background-color: red; */
                width: fit-content;
            }
        }
    }
</style>

<script>
    let includeTags: string[] = [];
    let excludeTags: string[] = [];
    
    const includeTagClass = "include-tag";
    const excludeTagClass = "exclude-tag";

    let searchText = "";

    interface ProjectCardData {
        projectCardEl: HTMLAnchorElement;
        tags: string[];
        title: string;
    }

    const projectElements = document.getElementsByClassName("project-card");
    const projectsData = new Array<ProjectCardData>();

    const filterPanel = document.querySelector(".filter-panel") as HTMLDivElement;

    const noProjectsFoundCard = document.getElementById("no-project-found");
    
    // Retrieving the project data for easier use later
    for (const project of projectElements) {
        const projectHtmlAnchorEl = project as HTMLAnchorElement;
        const tags = projectHtmlAnchorEl.dataset.tags?.split(',');
        const title = projectHtmlAnchorEl.dataset.title;
        if (!tags || !title) {
            console.error("Can't find project tag / title");
            continue;
        }

        const data: ProjectCardData = {
            projectCardEl: projectHtmlAnchorEl,
            tags: tags,
            title: title,
        };
        projectsData.push(data)
    }
    
    GetInfoFromURL();
    UpdateProjectVisibility();

    function GetInfoFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const params = Object.fromEntries(urlParams.entries());

        const urlSearchInput = params["searchText"];
        if (urlSearchInput !== undefined) {
            searchText = urlSearchInput;
        }
        
        const urlIncludeTags = params["includeTags"];
        if (urlIncludeTags !== undefined)
            includeTags = JSON.parse(urlIncludeTags);
        else
            includeTags = []; // Reset if not in url

        const urlExcludeTags = params["excludeTags"];
        if (urlExcludeTags !== undefined)
            excludeTags = JSON.parse(urlExcludeTags);
        else
            excludeTags = []; // Reset if not in url
    }

    // Selecting space bar if user presses '/'
    document.addEventListener('keydown', (event) => {
        if (event.key == '/') {
            searchInput.focus();
            event.preventDefault();
        }
    });

    const searchInput = document.getElementById("search-input") as HTMLInputElement;
    searchInput?.addEventListener("input", () => {
        searchText = searchInput.value;
        UpdateProjectVisibility();
    });

    const tags = filterPanel.getElementsByClassName("tag");
    for (const tag of tags) {
        const tagValue = (tag as HTMLElement).dataset.tag;
        if (!tagValue)
        {
            console.error("Can't find tag");
            continue;
        }

        tag.addEventListener("click", () => {
            // Replace include with exclude class
            if (tag.classList.contains(includeTagClass)) {
                tag.classList.replace(includeTagClass, excludeTagClass);
                
                includeTags.splice(includeTags.indexOf(tagValue), 1);
                excludeTags.push(tagValue);
            }
            // Remove exclude class (This tag isn't included or excluded)
            else if (tag.classList.contains("exclude-tag")) {
                tag.classList.remove(excludeTagClass);
                
                excludeTags.splice(excludeTags.indexOf(tagValue), 1);
            }
            // Add Include class
            else {
                tag.classList.add(includeTagClass);
                
                includeTags.push(tagValue);
            }

            UpdateProjectVisibility();
        })
    }

    function UpdateProjectVisibility() {
        let count = 0;
        // console.log(`IncludeTags: ${includeTags} \nExcludeTags: ${excludeTags}`);
        for (const project of projectsData) {
            const ifShow = 
                (!searchText || project.title.includes(searchText)) &&
                // Check if the project includes all include tags
                // (includeTags.length === 0 || project.tags.some((el) => includeTags.includes(el))) && // Check if ANY include tag
                (includeTags.length === 0 || includeTags.every((el) => project.tags.includes(el))) && // Check if ALL include tag
                // Check if the project has any of the excluded tags
                (excludeTags.length === 0 || excludeTags.some((el) => !project.tags.includes(el)));
            
            if (ifShow)
                count++;
            
            // project.projectCardEl.classList.remove("just-changed");
            // if (project.projectCardEl.classList.contains("hide") === ifShow) 
            //     project.projectCardEl.classList.add("just-changed");
            project.projectCardEl?.classList.toggle("hide", !ifShow)
        }

        // Hide this if there is at lesat 1 project
        noProjectsFoundCard?.classList.toggle("hide", count > 0);
    }
</script>